{% extends "teacher_base.html" %}
{% block title %}Teacher Dashboard - EduInsight{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">Teacher Dashboard</h2>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <a href="{% url 'teacher_feedback_form' %}" class="bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
            <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>
            <h3 class="text-lg font-semibold">Give Feedback</h3>
            <p class="text-sm opacity-90">Provide student feedback</p>
        </a>

        <a href="#" onclick="showClassOverview(); return false;" class="bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
            <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
            </svg>
            <h3 class="text-lg font-semibold">Class Analytics</h3>
            <p class="text-sm opacity-90">View performance graphs</p>
        </a>
    </div>

    <!-- Class Overview Chart -->
    <div id="classOverview" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Class Performance Overview</h3>
        <div style="position: relative; height: 400px;">
            <canvas id="classPerformanceChart"></canvas>
        </div>
    </div>

    <!-- Students Table with Enhanced Actions -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Registered Students</h3>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-800 text-white text-left">
                        <th class="p-3">Student Name</th>
                        <th class="p-3">Email</th>
                        <th class="p-3">Avg Test Score</th>
                        <th class="p-3">Attendance</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in students_data %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-700">
                            {{ data.student.first_name }} {{ data.student.last_name }}
                        </td>
                        <td class="p-3 text-gray-600">{{ data.student.email }}</td>
                        <td class="p-3">
                            <span class="font-semibold text-indigo-600">{{ data.avg_test_score|floatformat:1 }}</span>
                        </td>
                        <td class="p-3">
                            <span class="font-semibold text-green-600">{{ data.attendance_rate|floatformat:1 }}%</span>
                        </td>
                        <td class="p-3">
                            <div class="flex flex-wrap gap-2">
                                <a href="{% url 'student_performance_analysis' data.student.id %}"
                                   class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600"
                                   title="View detailed performance analysis with graphs">
                                   üìä Analysis
                                </a>
                                <a href="{% url 'manage_attendance' data.student.id %}"
                                   class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                   ‚úì Attendance
                                </a>
                                <a href="{% url 'manage_tests' data.student.id %}"
                                   class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                   üìù Tests
                                </a>
                                <a href="{% url 'suggest_courses' data.student.id %}"
                                   class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">
                                   üí° Suggest
                                </a>
                                <button onclick="predictPerformance({{ data.student.id }})"
                                        class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600">
                                   üîÆ Predict
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Prediction Modal -->
    <div id="predictionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Performance Prediction</h3>
            <div id="predictionContent" class="space-y-3">
                <!-- Content will be loaded here -->
            </div>
            <button onclick="closePredictionModal()" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                Close
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let classChart = null;

    function showClassOverview() {
        const overviewDiv = document.getElementById('classOverview');
        overviewDiv.classList.toggle('hidden');

        // Only create chart if it doesn't exist
        if (!classChart && !overviewDiv.classList.contains('hidden')) {
            const ctx = document.getElementById('classPerformanceChart').getContext('2d');
            classChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Math', 'Science', 'English', 'History', 'Geography'],
                    datasets: [{
                        label: 'Class Average',
                        data: [85, 78, 92, 73, 88],
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }
    }

    function predictPerformance(studentId) {
        document.getElementById('predictionModal').style.display = 'flex';
        document.getElementById('predictionContent').innerHTML = 'Loading...';

        fetch(`/api/predict/${studentId}/`)
            .then(response => response.json())
            .then(data => {
                const content = `
                    <div class="p-4 bg-indigo-50 rounded">
                        <p class="text-2xl font-bold text-indigo-600">
                            Predicted Grade: ${data.prediction.predicted_grade}%
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            Confidence: ${data.prediction.confidence}
                        </p>
                        <p class="text-sm text-gray-600">
                            Trend: ${data.prediction.trend}
                        </p>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Attendance</p>
                            <p class="font-semibold">${data.current_metrics.attendance_rate.toFixed(1)}%</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Grade Avg</p>
                            <p class="font-semibold">${data.current_metrics.grade_average.toFixed(1)}%</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Test Avg</p>
                            <p class="font-semibold">${data.current_metrics.test_average.toFixed(1)}%</p>
                        </div>
                    </div>
                `;
                document.getElementById('predictionContent').innerHTML = content;
            })
            .catch(error => {
                document.getElementById('predictionContent').innerHTML =
                    '<p class="text-red-600">Error loading prediction</p>';
            });
    }

    function closePredictionModal() {
        document.getElementById('predictionModal').style.display = 'none';
    }
</script>
{% endblock %}
